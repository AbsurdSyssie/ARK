---
title: "Automation of ARK Data Collection and Analysis"
author: "Oscar Daniel"
date: '2022-03-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

```

#### **Preamble**

Call libraries, set numbers not to display as exponents and import raw data

```{r}
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggthemes)
options(scipen = 999)
raw_data <- read.csv(file = "RAW_DATA\\Data Extract.csv")
Clean_Data <- raw_data 
```

## Data Tidying

Before data analysis can be done, the data needs to be changed so that it only has information that we want to look at, that the data is in the correct format and that there is no sensitive information contained within it.

#### **Anonymise NHS No.**

Full NHS numbers are included in our raw data so we want to anonymise this to prevent sensitive data being shared. Turning the NHS number into an arbitrary ID number is an easy way to do this whilst still retaining the grouping of data to an individual.

```{r}
#change NHS# into an arbitrary Patient ID No
PID <- Clean_Data %>%                                        # Create ID by group
  group_by(NHS.) %>%
  mutate(ID = cur_group_id())
Clean_Data$NHS. <- PID$ID
```

#### **Convert Data into Correct Format**

As the date columns come in character format, we need to convert them into date types so we can manipulate them properly later on. We can also set our character data to one case so that it is more readable and predictable.

```{r}
#make columns dates not characters
Clean_Data$Prescription.start <- dmy_hm(Clean_Data$Prescription.start) 
Clean_Data$Prescription.end <- dmy_hm(Clean_Data$Prescription.end)


#make all character columns same case to reduce number of duplicates and ease readability

Clean_Data$Reason.given <-str_to_upper(Clean_Data$Reason.given, locale ="en") 
Clean_Data$Name <-str_to_title(Clean_Data$Name, locale ="en")
Clean_Data$Route <-str_to_title(Clean_Data$Route, locale ="en")
```

#### **Remove inappropriate data**

First we need to format data remove any irrelevant or erroneous data.

```{r}
#remove duplicates
Clean_Data <- Clean_Data[!duplicated(Clean_Data), ]

#remove prescriptions before Dec 1st 2021 and ending after 2022
 
Clean_Data <- filter(Clean_Data, Prescription.start >= as.POSIXct("2021-12-01 00:00"))

Clean_Data <- filter(Clean_Data, Prescription.end < as.POSIXct("2022-12-31 00:00"))


  
#remove any stat, bleed, prophylactic abx, leg cramps, hepatic encephalopathy, SIADH or nystatin rx
  Clean_Data <- Clean_Data %>%
    filter(!(grepl("*BLEED*", Reason.given) | grepl("*PROPHY*", Reason.given) | grepl("*CRAMP*", Reason.given) | 
               grepl("MS", Reason.given) | grepl("*ONCE*", Frequency) | grepl("H.ENCEPH*", Reason.given) | grepl("*HEPATIC ENCEPHALOPATHY*", Reason.given) | grepl("NYSTATIN", Name) | grepl("NYSTAN", Name) | grepl("SIADH", Reason.given)))

```

#### **Regular expressions**

Use some regex to normalise common indication names, remove ambiguous abbreviations and correct for some spelling mistakes

```{r}
#make all UTIs display as Urinary Tract Infection
  Clean_Data$Reason.given <- gsub( "UTI", "URINARY TRACT INFECTION",Clean_Data$Reason.given) 
  
  #make all community acquired pneumonia display as CAP
  Clean_Data$Reason.given <- gsub("CAP", "COMMUNITY ACQUIRED PNEUMONIA", Clean_Data$Reason.given)
  
  #make all IEoCOPD as IECOPD
  Clean_Data$Reason.given <- gsub("IECOPD", "INFECTIVE EXACERBATION OF CHRONIC OBSTRUCTIVE PULMONARY DISEASE", Clean_Data$Reason.given) 
  
  #make all LRTI full name
  Clean_Data$Reason.given <- gsub("LRTI", "LOWER RESPIRATORY TRACT INFECTION", Clean_Data$Reason.given) 
  #make any blank indications "Unknown"
  Clean_Data$Reason.given <- sub("^$", "UNKOWN", Clean_Data$Reason.given)
  
  #correct common spelling mistakes
  Clean_Data$Reason.given <- gsub("PYONEPHRITIS", "PYELONEPHRITIS", Clean_Data$Reason.given)
  
  Clean_Data$Reason.given <- replace(Clean_Data$Reason.given,grep("DIFF",Clean_Data$Reason.given),"CLOSTRIDIUM DIFFICILE")
    
  
  Clean_Data$Reason.given <- str_to_title(Clean_Data$Reason.given)
  head( select(Clean_Data, c(NHS.,Name, Reason.given)))
```

## Data Wrangling

This is where we start to manipulate and extract important information from our dataset to be used in our visualisations.

#### Find Pertinent Information

For example we may want to find the most commonly prescribed antibiotics, or the most common reasons that antibiotics are prescribed;

```{r}
#find top n most frequently prescribed abx
pop_abx <- Clean_Data %>%
  count(Name) %>%
  top_n(10) %>% 
  arrange(-n) %>% 
  print()

#find top n most frequent indications
pop_indic <- Clean_Data %>%
  count(Reason.given) %>%
  top_n(10) %>% 
  arrange(-n) %>% 
  print()
```

We are also very interested in the length of prescriptions, we can make a new column in our table for just that;

```{r}
#take the difference between the start and end times of each rx, then make that a new column
Clean_Data$Prescription_Length <- interval(Clean_Data$Prescription.start, Clean_Data$Prescription.end) / hours(1)
head(select(Clean_Data, c(NHS., Prescription_Length)))

 #remove any prescriptions where they could not have had more than one dose 

 Clean_Data <- filter(Clean_Data, Frequency == "THREE times a DAY" & Prescription_Length > 8 | Frequency == "FOUR times a DAY" & Clean_Data$Prescription_Length > 6 | Frequency == "TWICE a DAY" & Prescription_Length > 12)

```
To help us understand what data is in each column we can look at the distinct values in each. This is much faster than looking through and making a note of what we see. For the indication this is useful to see if there are any common ways that things are misspelled;

```{r}
indications <- distinct(Clean_Data ,Clean_Data$Reason.given) %>% 
  head()
```

This can further inform our tidying process and clean up more commonly misspelled words and phrases.

#### Find popular antibiotics and popular indications over time

```{r find intermediate values}
#get the agents lined up by their start times and find their frequency on that day
agent_by_date <- Clean_Data %>%
  group_by(Prescription.start) %>%
  count(Name) 
#then find their cumulative frequency over time
agent_by_date <- agent_by_date %>%
  group_by(Name) %>%
  mutate(Cum_n = cumsum(n)) 

#then select only the most commonly prescribed abx
pop_agent_by_date <- filter(agent_by_date, Name %in% pop_abx$Name) %>%
  print()

agent_by_reason <- Clean_Data %>%
  group_by(Reason.given) %>%
  count(Name)

agent_by_reason <- filter(agent_by_reason,Reason.given %in% pop_indic$Reason.given) %>%
  print()
#organise pop indic by date and count how many over time
indic_by_date <- Clean_Data %>% 
  group_by(Prescription.start) %>% 
  count(Reason.given)
#find most common indications
indic_by_date <- indic_by_date %>% 
  filter(Reason.given %in% pop_indic$Reason.given) 
#find totals over time  
indic_by_date <- indic_by_date  %>% 
  mutate(Reason.given = str_to_title(Reason.given)) %>% 
  group_by(Reason.given) %>% 
  mutate(cum_n = cumsum(n))
```

#### **Pivoting**

Now that we have our data fairly tidy and we have the necessary information added, we want to arrange the data in a way which will reflect the way the ark project wants the data to look;

```{r}
Clean_Data <- Clean_Data %>% arrange(Prescription.start) %>%  group_by(NHS.)

#pivot wide
abx_per_indication <- Clean_Data%>% 
  group_by(NHS., Reason.given) %>% 
  mutate(rn = row_number()) %>%
  pivot_wider(values_from = c(Name,Route,Prescription.start,Prescription.end, Dose, 
                              Frequency, ARK.category, Prescription_Length ),
              names_from =  rn)
```

This groups the data by person and by the indication (as in ARK antibiotics should only be grouped by the same indication), and makes each row a course of antibiotics for an illness, rather than single prescriptions.

#### **Record Decisions**

As ARK wants us to record the decisions that were made between each prescription, such as IV to Oral, Oral to IV or stopped.

```{r Interval Calculation}
abx_per_indication <- abx_per_indication %>% 
  mutate(interval_1 = interval(Prescription.start_1, Prescription.start_2) / hours (1),
         interval_2 = interval(Prescription.start_2, Prescription.start_3) / hours (1),
         interval_3 = interval(Prescription.start_1, Prescription.start_4) / hours (1),
         interval_4 = interval(Prescription.start_1, Prescription.start_5) / hours (1),
         interval_5 = interval(Prescription.start_1, Prescription.start_6) / hours (1),
  )

```


```{r Decision Making}

#classify each change as per ARK protocol

#firstly, what was actually commenced
abx_per_indication <- abx_per_indication %>% 
  mutate(Decision_1 = case_when(
    Route_1 == "Intravenous" & Route_2 == "Intravenous" & interval_1 < 12 & 
      Prescription_Length_1 > 12 ~ 'Dual IV therapy started',
    Route_1 == "Intravenous" &  Route_2 == "Oral" & interval_1 < 12 & 
      Prescription_Length_1 > 12 ~ 'IV and Oral started',
    Route_1 =="Oral" & Route_2 == "Intravenous" & interval_1 < 12 ~ "IV and Oral started",
    interval_1 > 12  ~ paste0(Route_1, " started"),
    

                                TRUE ~ 'something else'
  ))

temp <- abx_per_indication %>% select(c(Name_1,Route_1,Prescription.start_1, Prescription.end_1, Decision_1, Name_2, Route_2, Prescription.start_2,Prescription.end_2,interval_1))

#what happened after the initial prescription

abx_per_indication <- abx_per_indication %>% 
  mutate(Decision_2 = case_when(
        Route_1 == Route_2 & Name_1 == Name_2 & Dose_1 == Dose_2 & Frequency_1 == Frequency_2 & 
        Route_1 == "Oral" ~ 'Oral agent continued',
        Route_1 == Route_2 & Name_1 == Name_2 & Dose_1 == Dose_2 & Frequency_1 == Frequency_2 & 
        Route_1 == "Intravenous" ~ 'IV agent continued',    
        Route_1 == Route_2 & Name_1 != Name_2  ~ paste0('Agent switched to ', Name_2),
        Route_1 == Route_2 & Dose_1 != Dose_2 & Frequency_1 != Frequency_2 & Name_1 == Name_2 ~ paste0('Regiment changed to ', Dose_2, " ",Frequency_2),
        Route_1 =="Intravenous" & Route_2 == "Intravenous" & ARK.category_2 == "FINAL" ~ paste0('Finalised as IV ', Name_2),
        Route_1 =="Oral" & Route_2 == "Oral" & is.na(Route_3) & ARK.category_2 == "FINAL" ~ paste0('Finalised as Oral ', Name_2),
        Prescription.end_1 < Prescription.start_2 + 1 ~ paste0(Route_1, " to ", Route_2, " switch"),
        Prescription.end_1 > Prescription.start_2 + 6 ~ paste0(Route_2, " " ,Name_2, " added"),
        Route_1 =="Intravenous" & is.na(Route_2) & Prescription_Length_1 <=72 ~ 'Stopped as IV within 72 hours',
    Route_1 =="Oral" & is.na(Route_2)  & Prescription_Length_1 <=72 ~ 'Stopped as Oral within 72 hours',
    Route_1 =="Intravenous" & is.na(Route_2) & Prescription_Length_1 > 72 ~ 'Stopped as IV beyond 72 hours',
    Route_1 =="Oral" & is.na(Route_2) & Prescription_Length_1 > 72 ~ 'Stopped as Oral beyond 72 hours',
        
        #Route_1 == Route_2 & Name_1 == Name_2 & Dose_1 == Dose_2 & Frequency_1 == Frequency_2  ~ 'No Change'
        
        
  ))
    
    
    
    
  #  Route_2 =="Intravenous" & Route_3 =="Oral" ~ 'IV to Oral Switch',
   #                             Route_2 =="Oral" & Route_3 =="Intravenous"  ~ 'Oral to IV Switch',
    #                            Route_2 =="Intravenous" & Route_3 == "Intravenous" & is.na(Route_4)  ~ 'Finalised as IV',
     #                           Route_2 =="Intravenous" & is.na(Route_3) & Prescription_Length_2 <=72 ~ 'Stopped as IV within 72 hours',
      #                          Route_2 =="Oral" & is.na(Route_3)  & Prescription_Length_2 <=72 ~ 'Stopped as Oral within 72 hours',
       #                         Route_2 =="Intravenous" & is.na(Route_3) & Prescription_Length_2 > 72 ~ 'Stopped as IV beyond 72 hours',
        #                        Route_2 =="Oral" & is.na(Route_3) & Prescription_Length_2 > 72 ~ 'Stopped as Oral beyond 72 hours',
         #                       Route_2 =="Oral" & is.na(Route_3)  ~ 'Stopped as Oral',
          #                      Route_2 == Route_3 & Name_2 == Name_3 & Dose_2 == Dose_3 & Frequency_2 == Frequency_3  ~ 'No Change',
           #                     Route_2 == Route_3 & Name_2 != Name_3  ~ 'Agent changed',
            #                    Decision_1 == "Finalised as Oral" | Decision_1 == "Finalised as IV"  ~ (""),
             #                   Route_2 == Route_3 & Dose_2 != Dose_3 | Frequency_2 != Frequency_3 ~ ('Regiment changed'),
              #                  TRUE ~ 'something else'
  #))

abx_per_indication <- abx_per_indication %>% 
  mutate(Decision_3 = case_when(Route_3 =="Intravenous" & Route_4 =="Oral" ~ 'IV to Oral Switch',
                                Route_3 =="Oral" & Route_4 =="Intravenous"  ~ 'Oral to IV Switch',
                                Route_3 =="Intravenous" & Route_4 == "Intravenous" & is.na(Route_3)  ~ 'Finalised as IV',
                                Route_3 =="Oral" & Route_4 == "Oral" & is.na(Route_3)  ~ 'Finalised as Oral',
                                Route_3 =="Intravenous" & is.na(Route_4) & Prescription_Length_3 <= 72 ~ 'Stopped as IV within 72 hours',
                                Route_3 =="Oral" & is.na(Route_4)  & Prescription_Length_3 <= 72 ~ 'Stopped as Oral within 72 hours',
                                Route_3 =="Intravenous" & is.na(Route_4) & Prescription_Length_3 > 72 ~ 'Stopped as IV beyond 72 hours',
                                Route_3 =="Oral" & is.na(Route_4) & Prescription_Length_3 > 72 ~ 'Stopped as Oral beyond 72 hours',
                                Route_3 == Route_4 & Name_3 == Name_4 & Dose_3 == Dose_4 & Frequency_3 == Frequency_4  ~ 'No Change',
                                Route_3 == Route_4 & Name_3 != Name_4  ~ ('Agent switched'),
                                
                                Route_3 == Route_4 & Dose_3 != Dose_4 | Frequency_3 != Frequency_4 ~ ('Regiment changed'),
                                Decision_2 == "Stopped as Oral within 72 hours" | Decision_2 == "Stopped as IV within 72 hours" | Decision_2 == "Stopped as Oral beyond 72 hours" | 
                                  Decision_2 == "Stopped as IV beyond 72 hours" | Decision_2 =="" ~ (""),
                                
                                TRUE ~ 'something else'
  ))




```

We will also be able to group people by the number of prescriptions there were in their antibiotic course;

```{r Group by number of prescriptions}

#first get rid of superfluous columns
ark_results <- abx_per_indication %>% 
  select(c(Name_1,Route_1, Name_2,Route_2, Name_3,Route_3,Name_4,Route_4,Decision_1,Decision_2,Decision_3,Prescription_Length_1,Prescription_Length_2,Prescription_Length_3,Prescription_Length_4, Prescription.start_1)) %>% 
  arrange(Name_4, Name_3, Name_2)

single_rx <- ark_results %>% 
  filter(is.na(Name_2)) %>% 
  select(c(Name_1,Route_1,Decision_1,Prescription_Length_1, Prescription.start_1))

double_rx <- ark_results %>% 
  filter(is.na(Name_3)) %>% 
  select(c(Name_1,Route_1,Decision_1, Name_2,Route_2,Decision_2))

triple_rx <- ark_results %>% 
  filter(is.na(Name_4)) %>% 
  select(-c(Name_4,Route_4))

quad_rx <- ark_results %>% 
  filter(!is.na(Name_4))
```

We want to know how long patients' total courses were, so let's do that;

```{a mistake}
#get rid of all missing values, then add course lengths together
course_lengths <-  abx_per_indication 

course_lengths$Prescription_Length_2[is.na(course_lengths$Prescription_Length_2)] <- 0 
course_lengths$Prescription_Length_3[is.na(course_lengths$Prescription_Length_3)] <- 0 
course_lengths$Prescription_Length_4[is.na(course_lengths$Prescription_Length_4)] <- 0 


course_lengths <- course_lengths %>%  mutate( course_length = (Prescription_Length_1 + Prescription_Length_2 + Prescription_Length_3 + Prescription_Length_4))
```


```{r Calculate the total course length}


#make course length the difference in time from the first agent being started and the last agent being finished

course_lengths <- abx_per_indication %>%  mutate(course_length =  case_when(
  is.na(Name_2) ~ Prescription_Length_1,
  is.na(Name_3) ~ interval(Prescription.start_1, Prescription.end_2)/ hours(1),
  is.na(Name_4) ~ interval(Prescription.start_2, Prescription.end_3)/ hours(1),
  is.na(Name_5) ~ interval(Prescription.start_3, Prescription.end_4)/ hours(1)))
 
  


course_lengths <- course_lengths %>%  select(c(course_length, Prescription.start_1,Prescription.start_2,Prescription.start_3,Prescription.start_4))
```

A course counts towards the month that it started in, not the month that it ended in.

ARK also wants to know how many prescriptions were stopped or changed within 72 hours each month, this could be changed to weekly or even hourly if we so desired.

```{r}
#floor all rx dates so they are organised by month. 
#then count the number in each month
rx_in_month <- select(Clean_Data, c(Prescription.start,Prescription_Length))

rx_in_month$Prescription.start <- floor_date(rx_in_month$Prescription.start, "month")

rx_in_month <- rx_in_month %>%  group_by(Prescription.start) %>%  count(Prescription.start)

#do the same as above, but then look for only the rx under 72hrs
rx_under_month <- select(Clean_Data, c(Prescription.start,Prescription_Length))
rx_under_month$Prescription.start <- (floor_date(rx_under_month$Prescription.start, "month")) 
rx_under_month <- rx_under_month %>% mutate(short_rx = Prescription_Length <= 72)
rx_under_month <- rx_under_month %>% 
  filter(short_rx == TRUE) 
rx_under_month <- rx_under_month %>%  group_by(Prescription.start)  %>%  count(short_rx)
#then divide the short rx by total rx
percent_in_month <- data.frame(rx_in_month$Prescription.start) %>%  mutate(percent_short = rx_under_month$n/rx_in_month$n *100)


```

We can then select for people who only had one prescription and whether that was stopped in 72 hours or less; / total course was less than 72 hours

```{r}
stopped_less_72 <- filter(single_rx, Prescription_Length_1 <= 72)

percent_stopped_72 <- nrow(stopped_less_72) / nrow(ark_results) *100
```

Now we want to see the previous result broken down by week

```{r}
rx_under_week_stopped <- select(single_rx, c(Prescription.start_1,Prescription_Length_1,Route_1))
rx_under_week_stopped$Prescription.start_1 <- 
  (floor_date(rx_under_week_stopped$Prescription.start_1, "week")) 
rx_under_week_stopped <- rx_under_week_stopped %>% mutate(short_rx = Prescription_Length_1 <= 72)
rx_under_week_stopped <- rx_under_week_stopped %>% 
  filter(short_rx == TRUE) 
rx_under_week_stopped <- rx_under_week_stopped %>%  group_by(Prescription.start_1)  %>%  count(short_rx)

```

Then we can find the total number of courses each week

```{r}
rx_in_week <- select(Clean_Data, c(Prescription.start,Prescription_Length,Route))

rx_in_week$Prescription.start <- floor_date(rx_in_week$Prescription.start, "week")

rx_in_week <- rx_in_week %>%  group_by(Prescription.start) %>%  count(Prescription.start)
```

Then compare them against each other

```{r}
percent_in_week_stopped <- data.frame(rx_in_week$Prescription.start) %>%  mutate(percent_short = rx_under_week_stopped$n/rx_in_week$n *100)
```

# Data Visualisation

Make a graph of the most common antibiotics used on lilac

```{r}
#top ten prescriptions
  ggplot(data=pop_abx, aes(y=reorder(Name, -n), x = n)) +
    # if wanting abx name on x axis- scale_x_discrete(guide = guide_axis(n.dodge=3)) +
    geom_bar(stat = "identity", fill="Steel Blue", colour="black") +
    xlab("Prescriptions on Lilac | 06-Dec-21 : 07-Mar-21") + ylab("Antibiotic") 

```

Make a graph of the most common indications

```{r}
 ggplot(pop_indic, aes(x =reorder(Reason.given, -n), y = n)) +
    scale_x_discrete("Indication", guide = guide_axis(n.dodge=3), 
    labels = c("Community Acquired Pneumonia" = "CAP",                              "Infective Exacerbation Of Chronic Obstructive Pulmonary Disease" = "IECOPD",
 "Lower Respiratory Tract Infection" = "LRTI",
 "Urinary Tract Infection" = "UTI",
 "Healthcare Associated Pneumonia" = "HAP")) + 
    geom_bar(stat = "identity", fill = "#F066EA")
```

Stacked bar graph of antibiotic for each indication

```{r}

  #stacked bar graph, abx by indic
  Abx_indic_stacked <- agent_by_reason %>%
    filter(Name %in% pop_abx$Name) %>%
    mutate(Reason.given = str_to_title(Reason.given)) %>%
    mutate(Name = str_to_title(Name)) 
  
  Abx_indic_stacked %>% 
    ggplot(aes(x = reorder(Reason.given, -n), y = n, fill =Name)) +
    theme(axis.text.x = element_text(angle = 15, vjust = 0.6)) +
    geom_bar(position='stack', stat='identity') +
    labs(x= "Indication", y= "No of Prescriptions", title="Proportion of Antibiotics by Indication") +
    scale_x_discrete("Indication", labels = c("Community Acquired Pneumonia" = "CAP",
                                              "Infective Exacerbation Of Chronic Obstructive Pulmonary Disease" = "IECOPD",
                                              "Lower Respiratory Tract Infection" = "LRTI",
                                              "Urinary Tract Infection" = "UTI",
                                              "Healthcare Associated Pneumonia" = "HAP"))
  
```

#### ARK Pertinent Graphs

Percent of individual prescriptions that had either stopped or been changed in 72 hours or less by month

```{r}
percent_in_month %>% 
    ggplot(aes(x = rx_in_month.Prescription.start, y = percent_short)) +
    ylim(0,100)+
    labs(x = "Month", y = "Percentage of rx <= 72 hours", title = "Prescriptions Stopped or Changed Within 72 Hours, Lilac Ward Dec '21 - Mar '22") +
    geom_bar(stat = "identity", fill = "coral") 
```

Percent of people who had a total course of less than or equal to 72 hours, by week;

```{r}
percent_in_week_stopped %>% 
    ggplot(aes(x = rx_in_week.Prescription.start, y = percent_short)) +
    ylim(0,100)+
    labs(x = "Month", y = "Percentage of rx <= 72 hours", title = "Antibiotic Courses Stopped Within 72 Hours, Lilac Ward Dec '21 - Mar '22", subtitle = "Including both oral and IV regiments") +
    geom_bar(stat = "identity", colour = "black", fill = "pink")
```
Then we can work out the number of people who had their prescription changed to another agent, and what percentage of those people had their first switch in <=72 hours.

```{r}
#get all courses where the second decision was that the drug was switched
rx_switched <- ark_results %>%  filter(grepl("*switch*", Decision_2, ignore.case = TRUE) | grepl("*change*", Decision_2, ignore.case = TRUE))
#floor by week to group them together
rx_switched$Prescription.start_1 <- floor_date(rx_switched$Prescription.start_1, "week")
#then take those and count how many there were each week
rx_switched_week <- rx_switched %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then select only the short ones
rx_switched_short <-rx_switched %>%  filter(Prescription_Length_1 <= 72)
#then count how many there were each week
rx_switched_short_week <- rx_switched_short %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then compare them 
percent_in_week_switched <- data.frame(rx_switched_week$Prescription.start_1) %>%  mutate(percent_short = rx_switched_short_week$n/rx_switched_week$n *100)

```

Then put them into a graph!

```{r}
percent_in_week_switched %>% 
    ggplot(aes(x = rx_switched_week.Prescription.start_1, y = percent_short)) +
    ylim(0,100)+
    labs(x = "Month", y = "Percentage of rx <= 72 hours", title = "Proportion of Antibiotic Switches that were Within 72 Hours, Lilac Ward Dec '21 - Mar '22", subtitle = "Including both oral and IV regiments") +
    geom_bar(stat = "identity", colour = "black", fill = "pink")
```

Find the proportion of all prescriptions that were an IV to oral switch within 72 hours, within each week

```{r}
#get all courses where the first decision was IV to oral
rx_switched <- ark_results %>%  filter(grepl("Intravenous to Oral*", Decision_2))
#floor by week to group them together
rx_switched$Prescription.start_1 <- floor_date(rx_switched$Prescription.start_1, "week")
#then take those and count how many there were each week
rx_switched_week <- rx_switched %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then select only the short ones
rx_switched_short <-rx_switched %>%  filter(Prescription_Length_1 <= 72)
#then count how many there were each week
rx_switched_short_week <- rx_switched_short %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then compare them 
percent_in_week_switched <- data.frame(rx_switched_week$Prescription.start_1) %>%  mutate(percent_short = rx_switched_short_week$n/rx_in_week[1:10,2] *100)

```

Make a graph

```{r}
percent_in_week_switched %>% 
    ggplot(aes(x = rx_switched_week.Prescription.start_1, y = percent_short$n)) +
   ylim(0,25)+
    labs(x = "Month", y = "Percentage of rx <= 72 hours", title = "IV to Oral switches that were within 72 Hours of the start of a course, as a percentage of all antibiotic courses | Lilac Ward Dec '21 - Mar '22") +
    geom_bar(stat = "identity", colour = "black", fill = "pink")
```
what about all IV to oral switches

```{r IV to Oral switches done within 72 hours}
#get all courses where the first decision was IV to oral switch
rx_switched <- ark_results %>%  filter(grepl("Intravenous to Oral*", Decision_2))
#floor by week to group them together
rx_switched$Prescription.start_1 <- floor_date(rx_switched$Prescription.start_1, "week")
#then take those and count how many there were each week
rx_switched_week <- rx_switched %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then select only the short ones
rx_switched_short <-rx_switched %>%  filter(Prescription_Length_1 <= 72)
#then count how many there were each week
rx_switched_short_week <- rx_switched_short %>%  group_by(Prescription.start_1) %>%  count(Prescription.start_1)
#then compare them 
percent_in_week_switched <- data.frame(rx_switched_week$Prescription.start_1) %>%  mutate(percent_short = rx_switched_short_week$n/rx_switched_week$n *100)
```

```{r}
percent_in_week_switched %>% 
    ggplot(aes(x = rx_switched_week.Prescription.start_1, y = percent_short)) +
   ylim(0,100)+
    labs(x = "Month", y = "Percentage of rx <= 72 hours", title = "IV to Oral switches that were within 72 Hours of the start of a course | Lilac Ward Dec '21 - Mar '22") +
    geom_bar(stat = "identity", colour = "black", fill = "pink")
```

